# Development

If you havenâ€™t touched this repo in weeks or months, start here.

## 0. Enter the dev environment

```bash
devbox shell
````

This loads:

* ansible
* terraform
* sops
* age
* task
* docker
* git

It also sets:

* `SOPS_AGE_KEY_FILE`
* useful aliases
* a controlled PATH

If you donâ€™t see:

```bash
ðŸš€ homelab-seed Devbox ready â€” env loaded
```

stop â€” nothing else will behave correctly.

## 1. Taskfiles

This repo is driven by **Taskfiles**, not raw commands.

### List available tasks

```bash
task --list
```

There are Taskfiles at:

* repo root
* `ansible/`
* `terraform/`

Use tasks unless you are debugging.

## 2. Common workflows

### Deploy / converge everything

```bash
task deploy
```

### Validate configs (no changes)

```bash
task validate
```

## 3. Terraform

Aliases are provided by devbox.

```bash
tf init
tf plan
tf apply
```

Terraform is responsible for:

* infrastructure definition
* inventory generation
* passing outputs to Ansible

## 4. Ansible (manual runs)

Normally invoked via tasks, but can be run directly:

```bash
ansible-playbook ansible/playbooks/deploy_core.yml
```

Configuration:

* config: `ansible/ansible.cfg`
* inventory: generated by Terraform
* variables: group/host vars + SOPS secrets

## 5. Secrets

This repo **does not use Ansible Vault**.

Secrets are managed with:

* **SOPS**
* **age**

Encrypted files live in:

```text
secrets/*.sops.yaml
```

Edit secrets **only** with:

```bash
sops secrets/common.sops.yaml
```

See `docs/secrets.md` for rules.

## 6. If something feels off

1. Exit the shell
2. Re-enter:

   ```bash
   devbox shell
   ```

3. Re-run:

   ```bash
   task validate
   ```

If that doesnâ€™t help, assume the repo has changed since last use and re-read:

* this file
* `docs/secrets.md`
* git pull
