# yaml-language-server: $schema=none
http:
  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https

    # crowdsec:
    #   plugin:
    #     crowdsec:
    #       # Enable the bouncer
    #       enabled: true
          
    #       # LAPI Connection Settings
    #       crowdsecLapiKey: "{{ crowdsec_bouncer_key | default('') }}"
    #       crowdsecLapiHost: "crowdsec:8080"  # host:port only (no scheme!)
    #       crowdsecLapiScheme: "http"
          
    #       # Operating mode: 'live' (query per request) or 'stream' (cache decisions)
    #       crowdsecMode: "live"
          
    #       # Custom ban/captcha pages
    #       banHTMLFilePath: "/etc/traefik/ban.html"
    #       captchaHTMLFilePath: "/etc/traefik/captcha.html"
          
    #       # AppSec/WAF Settings (optional - enable if using appsec collections)
    #       crowdsecAppsecEnabled: false
    #       crowdsecAppsecHost: "crowdsec:7422"
    #       crowdsecAppsecFailureBlock: true
    #       crowdsecAppsecUnreachableBlock: true
          
    #       # Trust internal IPs for X-Forwarded-For headers
    #       forwardedHeadersTrustedIPs:
    #         - "10.0.0.0/8"
    #         - "172.16.0.0/12"
    #         - "192.168.0.0/16"
          
    #       # Trusted client IPs (bypass bouncer checks)
    #       clientTrustedIPs:
    #         - "10.0.0.0/8"
    #         - "172.16.0.0/12"
    #         - "192.168.0.0/16"

  routers:
    # HTTP to HTTPS redirect router
    main-app-router-redirect:
      rule: "Host(`{{ pangolin_fqdn }}`)"
      service: next-service
      entryPoints:
        - web
      middlewares:
        - redirect-to-https

    # Next.js router (handles everything except API and WebSocket paths)
    next-router:
      rule: "Host(`{{ pangolin_fqdn }}`) && !PathPrefix(`/api/v1`)"
      service: next-service
      entryPoints:
        - websecure
      middlewares: []
      tls:
        certResolver: letsencrypt

    # API router (handles /api/v1 paths)
    api-router:
      rule: "Host(`{{ pangolin_fqdn }}`) && PathPrefix(`/api/v1`)"
      service: api-service
      entryPoints:
        - websecure
      middlewares: []
      tls:
        certResolver: letsencrypt

    # WebSocket router
    ws-router:
      rule: "Host(`{{ pangolin_fqdn }}`)"
      service: api-service
      entryPoints:
        - websecure
      middlewares: []
      tls:
        certResolver: letsencrypt

  services:
    next-service:
      loadBalancer:
        servers:
          - url: "http://pangolin:3002" # Next.js server

    api-service:
      loadBalancer:
        servers:
          - url: "http://pangolin:3000" # API/WebSocket server
