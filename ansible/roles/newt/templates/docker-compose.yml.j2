# {{ ansible_managed }}

services:
  newt:
    image: {{ newt_image }}
    container_name: newt
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    env_file:
      - ./.env

    environment:
      # Docker integration
      - DOCKER_SOCKET=/var/run/docker.sock
      - DOCKER_ENFORCE_NETWORK_VALIDATION=true

      # Networking
      - MTU={{ newt_mtu }}
      - DNS={{ newt_dns }}
      - PING_INTERVAL={{ newt_ping_interval }}
      - PING_TIMEOUT={{ newt_ping_timeout }}
      - RELAY_PORT={{ newt_relay_port }}

      # Performance
      - UDP_RECEIVE_BUFFER_SIZE={{ newt_udp_receive_buffer_size }}
      - MAX_UDP_PACKET_SIZE={{ newt_max_udp_packet_size }}

      # Monitoring
      - LOG_LEVEL={{ newt_log_level }}
      - HEALTH_FILE=/tmp/newt_healthy
      - HOSTINFO_CHECK_INTERVAL={{ newt_hostinfo_interval }}
      - NEWT_METRICS_PROMETHEUS_ENABLED={{ newt_metrics_enabled }}
      - NEWT_ADMIN_ADDR={{ newt_metrics_addr }}

    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/newt_healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    networks:
      - {{ newt_network }}

networks:
  {{ newt_network }}:
    external: true
