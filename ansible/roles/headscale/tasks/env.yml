---
# {{ ansible_managed }}

- name: Check Headscale API key file
  ansible.builtin.stat:
    path: "{{ headscale_config_dir }}/api_key.key"
  register: headscale_key_stat

- name: Fail if bootstrap but no key
  ansible.builtin.fail:
    msg: "headscale_api_key required for bootstrap (SOPS)."
  when:
    - headscale_bootstrap | default(false)
    - (headscale_api_key is not defined) or (headscale_api_key | length == 0)

- name: Set key path and exists fact
  ansible.builtin.set_fact:
    headscale_api_key_file: "{{ headscale_config_dir }}/api_key.key"
    headscale_key_exists: "{{ headscale_key_stat.stat.exists | default(false) | bool }}"
